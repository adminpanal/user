<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    async function logout() {
      const logoutBtn = document.getElementById('logoutBtn');
      logoutBtn.disabled = true;
      logoutBtn.innerHTML = 'Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬... <span class="loading"></span>';

      try {
        if (currentEmployee) {
          // ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          const logData = {
            employee_id: currentEmployee.id,
            center_id: currentEmployee.center_id,
            action: 'manual_checkout',
            latitude: null,
            longitude: null,
            accuracy: null,
            occurred_at: new Date().toISOString(),
            notes: 'Ø®Ø±ÙˆØ¬ ÙŠØ¯ÙˆÙŠ'
          };

          await supabase.from('logs').insert([logData]);
          await supabase.from('employees')
            .update({ status: 'inactive' })
            .eq('id', currentEmployee.id);
        }

        // Ø¥ÙŠÙ‚Ø§Ù Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹
        if (locationWatchId) {
          navigator.geolocation.clearWatch(locationWatchId);
          locationWatchId = null;
        }

        // Ù…Ø³Ø­ Ø§Ù„Ø¬Ù„Ø³Ø©
        localStorage.removeItem(SESSION_KEY);
        currentEmployee = null;

        // Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        document.getElementById('successContainer').classList.add('hidden');
        document.getElementById('loginContainer').classList.remove('hidden');
        
        // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
        document.getElementById('phoneInput').value = '';
        document.getElementById('passwordInput').value = '';

      } catch (err) {
        console.error('Logout error:', err);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
      }

      logoutBtn.disabled = false;
      logoutBtn.innerText = 'ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬';
    }

    .container {
      width: 100%;
      max-width: 350px;
      padding: 40px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      text-align: center;
    }

    .logo {
      font-size: 2.5em;
      margin-bottom: 30px;
      color: #667eea;
      font-weight: bold;
    }

    input {
      width: 100%;
      padding: 15px 20px;
      margin: 10px 0;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 16px;
      text-align: center;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }

    input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    button {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 20px;
    }

    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .success-message {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      padding: 20px;
      border-radius: 15px;
      font-size: 20px;
      font-weight: bold;
      animation: fadeIn 0.5s ease-in;
    }

    .hidden {
      display: none;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s ease-in-out infinite;
      margin-left: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
  <div class="container" id="loginContainer">
    <div class="logo">ğŸ”</div>
    <input type="tel" id="phoneInput" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" maxlength="15" />
    <input type="password" id="passwordInput" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
    <button id="loginBtn" onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
  </div>

  <!-- Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ -->
  <div class="container hidden" id="successContainer">
    <div class="success-message">
      âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­
    </div>
    <button id="logoutBtn" style="background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); margin-top: 20px;">
      ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
    </button>
  </div>

  <script>
    const supabaseUrl = 'https://qcbcjyhqgxwuqutzkxrh.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFjYmNqeWhxZ3h3dXF1dHpreHJoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEyMDE3NjQsImV4cCI6MjA2Njc3Nzc2NH0.y-hQVa6nzBpCMpXL7XbcWPMGafATvnMez3lAmFvb2zY';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
    const SESSION_KEY = 'employee_session';
    let currentEmployee = null;
    let locationWatchId = null;

    // Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø© Ù„Ù…Ø¯Ø© 48 Ø³Ø§Ø¹Ø©
    function saveSession(employee) {
      const data = {
        employee,
        timestamp: Date.now()
      };
      const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(data))));
      localStorage.setItem(SESSION_KEY, encoded);
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
    function loadSession() {
      const item = localStorage.getItem(SESSION_KEY);
      if (!item) return null;
      try {
        const decoded = decodeURIComponent(escape(atob(item)));
        const parsed = JSON.parse(decoded);
        const now = Date.now();
        const diff = now - parsed.timestamp;
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¬Ù„Ø³Ø© Ù„Ù…Ø¯Ø© 48 Ø³Ø§Ø¹Ø©
        if (diff <= 48 * 60 * 60 * 1000) {
          return parsed.employee;
        } else {
          localStorage.removeItem(SESSION_KEY);
          return null;
        }
      } catch {
        return null;
      }
    }

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
    async function login() {
      const phone = document.getElementById('phoneInput').value.trim();
      const password = document.getElementById('passwordInput').value.trim();
      const loginBtn = document.getElementById('loginBtn');

      if (!phone || !password) return;

      loginBtn.disabled = true;
      loginBtn.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚... <span class="loading"></span>';

      try {
        const { data, error } = await supabase.rpc('authenticate_employee', {
          employee_phone: phone,
          employee_password: password
        });

        if (error || !data.success) {
          alert('Ø®Ø·Ø£ ÙÙŠ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
          loginBtn.disabled = false;
          loginBtn.innerText = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
        } else {
          const employee = data.employee;
          currentEmployee = employee;
          saveSession(employee);
          
          // Ø¥Ø®ÙØ§Ø¡ ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
          document.getElementById('loginContainer').classList.add('hidden');
          document.getElementById('successContainer').classList.remove('hidden');
          
          // Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
          setTimeout(() => {
            runBackgroundOperations(employee);
          }, 2000);
        }
      } catch (err) {
        console.error(err);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
        loginBtn.disabled = false;
        loginBtn.innerText = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
      }
    }

    // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ© (Ù…Ø®ÙÙŠØ© ØªÙ…Ø§Ù…Ø§Ù‹)
    async function runBackgroundOperations(employee) {
      try {
        // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø§ÙƒØ²
        const { data: centers } = await supabase.from('centers').select('*');
        const myCenter = centers.find(c => c.id === employee.center_id);

        if (myCenter && navigator.geolocation) {
          // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©
          locationWatchId = navigator.geolocation.watchPosition(
            async (position) => {
              const distance = getDistance(
                position.coords.latitude,
                position.coords.longitude,
                myCenter.latitude,
                myCenter.longitude
              );

              const inCenter = distance <= myCenter.radius;

              // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
              const logData = {
                employee_id: employee.id,
                center_id: myCenter.id,
                action: inCenter ? 'auto_checkin' : 'auto_checkout',
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                accuracy: position.coords.accuracy,
                occurred_at: new Date().toISOString(),
                notes: inCenter ? 'Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ' : 'Ø®Ø±ÙˆØ¬ ØªÙ„Ù‚Ø§Ø¦ÙŠ'
              };

              await supabase.from('logs').insert([logData]);
              await supabase.from('employees')
                .update({ status: inCenter ? 'active' : 'inactive' })
                .eq('id', employee.id);
            },
            (err) => console.error('Location error:', err),
            {
              enableHighAccuracy: true,
              maximumAge: 5000,
              timeout: 10000
            }
          );
        }
      } catch (err) {
        console.error('Background operations error:', err);
      }
    }

    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ù†Ù‚Ø·ØªÙŠÙ†
    function getDistance(lat1, lon1, lat2, lon2) {
      const R = 6371000; // Ù†ØµÙ Ù‚Ø·Ø± Ø§Ù„Ø£Ø±Ø¶ Ø¨Ø§Ù„Ù…ØªØ±
      const toRad = (val) => val * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¬Ù„Ø³Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    window.addEventListener('DOMContentLoaded', async () => {
      const employee = loadSession();
      if (employee) {
        currentEmployee = employee;
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø¬Ù„Ø³Ø© Ù…Ø­ÙÙˆØ¸Ø©ØŒ Ø§Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ Ù…Ø¨Ø§Ø´Ø±Ø©
        document.getElementById('loginContainer').classList.add('hidden');
        document.getElementById('successContainer').classList.remove('hidden');
        runBackgroundOperations(employee);
      }
      
      // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ÙŠ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ù„Ù„Ø£Ø²Ø±Ø§Ø±
      document.getElementById('loginBtn').addEventListener('click', login);
      document.getElementById('logoutBtn').addEventListener('click', logout);
    });

    // Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Enter
    document.getElementById('passwordInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        login();
      }
    });
  </script>
</body>
</html>
